{% extends "base_site.html" %}

{% block title %} Tables {% endblock title %}

{% block stylesheets %}
{{ super() }}
{% endblock stylesheets %}

{% block content %}

{% include "site_template/navigation.html" %}

{% include "site_template/top-stats.html" %}

<div class="container-fluid mt--7">
  <div class="card shadow">
    <div class="card-header border-0">
      <h3> {{ _('Поиск Пациента') }} </h3>
      <form method="GET" id="searchForm">
        <input type="hidden" style="display: none;" name="per_page" value="{{ all_patients_table.per_page }}">
        {% if select_contacted %}
        <input type="text" name="select_contacted_id" style="display:none;" value="{{ select_contacted }}">
        {% endif %}      
        <div class="card shadow mt-3">
          <div class="card-header border-0">
            <div class="row">
              <div class="col-xl">
                <label class='form-control-label'>{{ _('Фамилия') }}</label>
                {{ form.second_name(class="form-control", placeholder=_('Фамилия')) }}              
              </div>
              <div class="col-xl">
                <label class='form-control-label'>{{ _('Имя') }}</label>
                {{ form.first_name(class="form-control", placeholder=_('Имя')) }}              
              </div>
              <div class="col-xl">
                <label class='form-control-label'>{{ _('Отчество') }}</label>
                {{ form.patronymic_name(class="form-control", placeholder=_('Отчество')) }}              
              </div>                            
              <div class="col-xl">
                <label class='form-control-label'>{{ _('ИИН') }}</label>
                {{ form.iin(class="form-control", placeholder=_('ИИН')) }}              
              </div>
            </div>
          </div>
        </div>
          <div class="card shadow mt-3">
            <div class="card-header border-0">
              <div class="row">
                <div class="col">
                  <label class='form-control-label'>{{ _('Начало Периода') }}</label>
                  {{ form.date_range_start(class="form-control datepicker", type="date") }}              
                </div>
                <div class="col">
                  <label class='form-control-label'>{{ _('Конец Периода') }}</label>                
                  {{ form.date_range_end(class="form-control datepicker", type="date") }}              
                </div>
                <div class="col">
                  <label class='form-control-label'>{{ _('Категория Работы') }}</label>                
                  {{ form.job_category_id(class="form-control") }}
                </div>
                <div class="col">
                  <label class='form-control-label'>{{ _('Фильтр по ИИН') }}</label>
                  {{ form.is_iin_fail(class="form-control") }}
                </div>             
              </div>
            </div>
          </div>
        <div class="card shadow mt-3">
          <div class="card-header border-0">
            <div class="row">
              <div class="col-xl">
                <label class='form-control-label'>{{ _('Адрес') }}</label>
                {{ form.address(class="form-control", placeholder=_('Страна/Город/Улица и т.д.')) }}              
              </div>
              <div class="col-xl">
                <label class='form-control-label'>{{ _('Регион') }}</label>                
                {{ form.region_id(class="form-control") }}
              </div>                            

              <div class="col-md-auto">
                <label class='form-control-label'>{{ _('Инфицирован') }}</label>                
                {{ form.is_infected(class="form-control") }}
              </div>
              <div class="col-md-auto">
                <label class='form-control-label'>{{ _('Найден') }}</label>                
                {{ form.is_found(class="form-control") }}
              </div>
              <div class="col-md-auto">
                <label class='form-control-label'>{{ _('Статус Пациента') }}</label>                
                {{ form.patient_status(class="form-control") }}
              </div>                            
            </div>
          </div>
        </div>
        <div class="card shadow mt-3">
          <div class="card-header border-0">        
            <div class="row">
              <div class="col">
                {% with form=form %}
                {% include "patients/modules/travel_form.html" %}
                {% endwith %}   
              </div>
            </div>
          </div>
        </div>
          <button type="submit" class="btn btn-primary btn-full-width mt-3" type="button">
            {{ _('Поиск') }}
          </button>
    </div>
  </div>

  <!-- Table -->
  <div class="row mt-3">
    <div class="col">
      {% with table=all_patients_table, search_fields = [] %}
        {% include "modules/table/table.html" %}
      {% endwith %}                 
    </div>
  </div>
  <!-- Footer -->
  {% include "site_template/footer.html" %}
</div>        
</form>

{% endblock content %}

{% block javascripts %}
{{ super()}}
<script type="text/javascript">
  {% with form=form, c=constants %}
  {% include "js/travel_form.html" %}
  {% endwith %}

  update_travel_form()

  $("#travel_type").on("change", function(){
    update_travel_form();
  });

  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const travel_type = urlParams.get('travel_type')
  
  if (travel_type !== null) {
    if (travel_type == '{{ constants.flight_type[0] }}') {
      flight_arrival_date = urlParams.get('flight_arrival_date')
      if(flight_arrival_date !== null) {
        $('#flight_arrival_date').val(flight_arrival_date)
      }
      
      get_flights_by_date()
      flight_code_id = urlParams.get('flight_code_id')
      if(flight_code_id !== null) {
        $('#flight_code_id').val(flight_code_id)
      }
    } else if (travel_type == '{{ constants.train_type[0] }}') {
      train_departure_date = urlParams.get('train_departure_date')
      if(train_departure_date !== null) {
        $('#train_departure_date').val(train_departure_date)
      }

      train_arrival_date = urlParams.get('train_arrival_date')
      if(train_arrival_date !== null) {
        $('#train_arrival_date').val(train_arrival_date)
      }
      
      get_trains_by_date_range()
      train_id = urlParams.get('train_id')
      if(train_id !== null) {
        $('#train_id').val(train_id)
      }
    }
  }

</script>


  {% with change=change, error_msg=error_msg %}
    {% include "site_template/change_notification.html" %}
  {% endwith %}

{% endblock javascripts %}